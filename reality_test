#!/bin/bash
set -e

# é…ç½®
PORT=443
SNI="www.cloudflare.com"
WORK_DIR="/etc/sing-box"
BIN_PATH="$WORK_DIR/sing-box"
SERVICE_FILE="/etc/systemd/system/sing-box.service"

log() { echo -e "\033[32m[INFO]\033[0m $1"; }
error() { echo -e "\033[31m[ERROR]\033[0m $1" >&2; exit 1; }

# æ£€æŸ¥ root
[[ $EUID -ne 0 ]] && error "è¯·ä»¥ root èº«ä»½è¿è¡Œ"

# åœæ­¢æ—§æœåŠ¡
systemctl stop sing-box 2>/dev/null || true
pkill -f sing-box 2>/dev/null || true

# å®‰è£…ä¾èµ–
log "å®‰è£…ä¾èµ–..."
apt-get update -qq
apt-get install -y -qq curl wget tar openssl jq

# èŽ·å–å…¬ç½‘ IPv4
IP=$(curl -s4m5 ip.sb || curl -s4m5 ifconfig.me)
[[ -z "$IP" ]] && error "æ— æ³•èŽ·å–å…¬ç½‘ IPv4"

# ä¸‹è½½ sing-box
log "ä¸‹è½½ sing-box..."
ARCH=$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/')
TAG=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
URL="https://github.com/SagerNet/sing-box/releases/download/${TAG}/sing-box-${TAG#v}-linux-${ARCH}.tar.gz"

mkdir -p "$WORK_DIR"
wget -qO /tmp/sb.tar.gz "$URL"
tar -xzf /tmp/sb.tar.gz -C /tmp
mv /tmp/sing-box-*-linux-*/sing-box "$BIN_PATH"
chmod +x "$BIN_PATH"
rm -rf /tmp/sb*

# ç”Ÿæˆå¯†é’¥
log "ç”Ÿæˆ Reality å¯†é’¥..."
KEYPAIR=$("$BIN_PATH" generate reality-keypair)
PRIVATE_KEY=$(echo "$KEYPAIR" | awk '/PrivateKey:/ {print $2}')
PUBLIC_KEY=$(echo "$KEYPAIR" | awk '/PublicKey:/ {print $2}')
UUID=$("$BIN_PATH" generate uuid)
SHORT_ID=$(openssl rand -hex 4)

# å†™å…¥é…ç½®
cat > "$WORK_DIR/config.json" <<EOF
{
  "log": { "level": "info" },
  "inbounds": [
    {
      "type": "vless",
      "listen": "::",
      "listen_port": $PORT,
      "users": [{ "uuid": "$UUID", "flow": "xtls-rprx-vision" }],
      "tls": {
        "enabled": true,
        "server_name": "$SNI",
        "reality": {
          "enabled": true,
          "handshake": { "server": "$SNI", "server_port": 443 },
          "private_key": "$PRIVATE_KEY",
          "short_id": ["$SHORT_ID"]
        }
      }
    }
  ],
  "outbounds": [{ "type": "direct" }]
}
EOF

# systemd æœåŠ¡
cat > "$SERVICE_FILE" <<EOF
[Unit]
Description=sing-box Reality Service
After=network.target

[Service]
ExecStart=$BIN_PATH run -c $WORK_DIR/config.json
Restart=on-failure
User=root

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now sing-box

# ç”Ÿæˆåˆ†äº«é“¾æŽ¥
SHARE_LINK="vless://${UUID}@${IP}:${PORT}?security=reality&encryption=none&pbk=${PUBLIC_KEY}&fp=chrome&sni=${SNI}&sid=${SHORT_ID}&type=tcp&flow=xtls-rprx-vision#Reality-Test"

log "âœ… å®‰è£…å®Œæˆï¼"
echo
echo "ðŸ”— åˆ†äº«é“¾æŽ¥ï¼š"
echo "$SHARE_LINK"
echo
echo "ðŸ“± æ‰«ç ï¼ˆéœ€æ”¯æŒ Reality
